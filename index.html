<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>
    Sensors
  </title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <title>Move phone game</title>
</head>

<body>
  <main role="main" class="container">
    <h1>Move phone game 123</h1>

    <div class="p-3 mb-2 bg-secondary" id="demo-div">
      <a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start the demo</a>

      <h2>
        Move mode:
        <p id="moveMode"></p>
      </h2>

      <p style="margin-top: 1rem;">
        Num. of datapoints:
        <span class="badge badge-warning" id="num-observed-events">0</span>
      </p>

      <h4>Accelerometer</h4>
      <ul>
        <li>
          X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span>
        </li>
        <li>
          Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span>
        </li>
        <li>
          Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span>
        </li>
        <li>
          Data Interval: <span id="Accelerometer_i">0</span><span> ms</span>
        </li>
      </ul>

      <div id="exportOutput"></div>
  </main>
  <div id="settings">
    <h3>Settings</h3>
  </div>
  <footer class="footer">
    <div class="container"></div>
  </footer>
  <script>

    function updateFieldIfNotNull(fieldName, value, precision = 10) {
      if (value != null)
        document.getElementById(fieldName).innerHTML = value.toFixed(
          precision
        );
    }

    const last100 = []
    let last100Sum = 0
    function handleMotion(event) {
      updateFieldIfNotNull("Accelerometer_x", event.acceleration.x);
      updateFieldIfNotNull("Accelerometer_y", event.acceleration.y);
      updateFieldIfNotNull("Accelerometer_z", event.acceleration.z);

      updateFieldIfNotNull("Accelerometer_i", event.interval, 2);
      const acc = event.acceleration
      const sum = ['x', 'y', 'z'].map(key => Math.abs(acc[key])).reduce((a, b) => a + b) * event.interval
      last100.push(sum)
      last100Sum += sum
      if (last100.length > 100) {
        const old = last100.slice()
        last100Sum -= old
      }

    }


    let is_running = false;
    let demo_button = document.getElementById("start_demo");
    //
    demo_button.onclick = function (e) {


      e.preventDefault();

      // Request permission for iOS 13+ devices
      if (
        DeviceMotionEvent &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        DeviceMotionEvent.requestPermission();
      }

      if (is_running) {
        window.removeEventListener("devicemotion", handleMotion);
        demo_button.innerHTML = "Start demo";
        demo_button.classList.add("btn-success");
        demo_button.classList.remove("btn-danger");
        is_running = false;
      } else {
        window.addEventListener("devicemotion", handleMotion);
        document.getElementById("start_demo").innerHTML = "Stop demo";
        demo_button.classList.remove("btn-success");
        demo_button.classList.add("btn-danger");
        is_running = true;
      }


    };


  </script>
</body>

</html>